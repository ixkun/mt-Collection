2）方案设计

一、背景

到综0元开店宝政策持续近一年，0元开店宝与付费商户通有一定的权益差异，目前自助侧的0元签约每周1000+，占所有0元的8%，因此需支持自助侧0元升级为付费商户通的功能。

二、目标

业务上，通过本次需求，希望能够支持商户在已经签约了0元商户通的基础上，可以自助升级付费商户通。

三、需求分析

1）正向流程

商家在已经签约了0元开店宝后，升级付费商户通的逻辑如下：

商家购买了0元开店宝后的升级动作，可以分为两步，1）终止现有的0元开店宝，2）创建付费方案。这两个动作的顺序对于业务的影响是不同的。具体分析如下：

方案1:终止0元开店宝-->创建付费方案

方案2:创建付费方案-->终止0元开店宝

说明

执行顺序，先终止0元方案，成功后再创建付费方案

执行顺序，先创建付费方案，成功后，再终止0元方案

优点

流程上符合一般对于升级的认知，升级过程中也满足广告侧对于库存的卡控。

创建广告方案后，如果终止0元开店宝方案失败，可以方便回滚，不会出现数据不一致的情况。

缺点

终止0元开店宝后，创建付费方案前，会存在短暂的商户无任何有效权益的情况，可能导致团购商品被下线，无法自动上线。

创建付费方案失败，导致升级失败，会导致当前商户无任何有效权益，包括0元权益

在创建付费方案后，终止0元方案前，会有一段时间商户存在两个方案，这个不符合广告侧的库存卡控逻辑。

2）逆向流程

此次不涉及到逆向流程，直接利用现有的业务流程支持逆向操作，如果商家在从0元升级为付费商户通之后希望退款，则走销售退款终止流程，后续商家可以选择继续合作0元开店宝。

3）非功能性分析

非功能需求项

具体子项

预计目标

备注

可用性

核心接口可用性

999

性能

响应时间

1500ms[999Line]

QPS

5

核心的提交接口属于低频写接口。

安全审计

一致性保证

最终一致性

涉及，升级失败需要保证各系统数据移植

幂等保证

服务端保证

涉及，本次

Web安全

[水平/垂直]越权/流量攻击/风控等

涉及，代码中需要对鉴权逻辑进行处理

审计日志

LOG文件+持久化存储

涉及，接入商家审计日志。

测试

测试

单元测试+开发自测+QA联测等

运维

部署

开发维护

四、系统设计

1）系统演进

本次需求需要对商户自助签约流程中的提交合作方案的逻辑进行修改，需要能做到以下几点：

1、识别商户是否有正在生效的0元领取记录，如果有，返回方案Id

2、在排除0元领取记录的基础上，计算当前可以签约的时间

3、终止0元方案。

2）自助签约现状

产品信息接口逻辑

提交接口逻辑

3）整体流程编排

（待补充）

4）升级起始时间选择

在升级过程中，商家可能存在多个不同的合作产品，且不同的合作方案之间的有效期相对位置不同，这就导致在实际升级过程中，有多重情况需要考虑，现就不同的情况分别枚举之：

5）待终止方案的确定

在对0元开店宝升级的时候，无需区分0元开店宝签约的渠道（销售签约or商家自助签约），因此，需要根据门店获取门店当前及未来生效的单据及对应的广告方案Id，用于后续作为终止方案的依据。目前根据门店获取0元开店宝的合作方案信息，主要有两条路径：

逻辑1:根据履约单据获取0元合作方案信息

逻辑2:根据广告方案获取0元合作方案信息

逻辑

根据门店获取当前及未来有效的履约单

将履约单中的免费开店宝类型的过滤出来

将广告签约渠道的单据过滤出来

根据单据获取关联的广告方案及订单信息

根据门店Id获取广告方案信息

根据广告方案信息获取订单信息，并根据订单上的产品Id将免费开店宝类型的数据过滤出来

优势

由于是根据履约单反推广告方案id，只会定位到少量的方案信息，因此不存在大方案问题。

无需感知广告方案上的复杂数据结构。

可以根据单据信息先对数据进行过滤。

调用过程简单，只需要调用一个接口，即可获取广告方案信息。

劣势

内部逻辑比较复杂，需要查询履约单、冗余的订单信息、产品分类等。

拿到方案信息后，需要解析方案中每个订单的有效期数据、过滤免费产品，后续的处理逻辑比较复杂，而且与履约处理流程的整体逻辑是重复的，可能会有大方案的问题。

最终选择逻辑1。

接口逻辑如下：

6）方案有效期重叠卡控逻辑调整

7）广告方案终止逻辑对接

广告方案终止的能力目前是现成能力，广告方案侧可以根据指定的广告方案Id执行方案终止逻辑。（接入文档待补充）

8）历史逻辑移除

移除门店营业状态校验

移除多门店客户无法新签的校验
